<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase 即時記分板</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .digital-font {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d2d2d; 
        }
        ::-webkit-scrollbar-thumb {
            background: #555; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #777; 
        }
        .btn-press:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs (Compat version suitable for standalone HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // Firebase 初始化邏輯
        // ==========================================
        
        // 嘗試從環境變數獲取配置，如果在預覽環境中
        let app, db, auth;
        let isFirebaseReady = false;

        try {
            // 優先檢查是否有預注入的配置 (針對這個預覽環境)
            if (typeof __firebase_config !== 'undefined') {
                const config = JSON.parse(__firebase_config);
                app = firebase.initializeApp(config);
                db = firebase.firestore();
                auth = firebase.auth();
                isFirebaseReady = true;

                // 處理匿名登入
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    auth.signInAnonymously();
                }
            }
        } catch (e) {
            console.error("Firebase auto-init failed:", e);
        }

        // ==========================================
        // 組件: 設定畫面 (如果沒有自動配置)
        // ==========================================
        const ConfigScreen = ({ onConfigSubmit }) => {
            const [configStr, setConfigStr] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                try {
                    // 嘗試解析並初始化
                    const config = JSON.parse(configStr);
                    if (!firebase.apps.length) {
                        app = firebase.initializeApp(config);
                        db = firebase.firestore();
                        auth = firebase.auth();
                        auth.signInAnonymously().catch(err => console.error("Auth Error", err));
                    }
                    onConfigSubmit();
                } catch (err) {
                    setError("無效的 JSON 格式或 Firebase 初始化失敗。請檢查控制台。");
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-gray-800 p-8 rounded-lg shadow-lg max-w-md w-full">
                        <h2 className="text-2xl font-bold mb-4 text-blue-400">設定 Firebase</h2>
                        <p className="text-gray-300 mb-4 text-sm">
                            // 請貼上您的 Firebase Config JSON 對象 (從 Firebase Console > Project Settings 獲取)。
                            const firebaseConfig = {
                                apiKey: "AIzaSyDEIqjG6E6szWA2m_-UNsBVUV9p_OpHIEI",
                                authDomain: "score-board-33f85.firebaseapp.com",
                                projectId: "score-board-33f85",
                                storageBucket: "score-board-33f85.firebasestorage.app",
                                messagingSenderId: "584844612174",
                                appId: "1:584844612174:web:63dc7c2d70b3e57767a91f",
                                measurementId: "G-6LFECKTTB4"
                            };
                        </p>
                        <textarea
                            className="w-full bg-gray-900 text-green-400 font-mono text-xs p-3 rounded h-40 mb-4 border border-gray-700 focus:outline-none focus:border-blue-500"
                            placeholder='{ "apiKey": "...", "authDomain": "...", ... }'
                            value={configStr}
                            onChange={(e) => setConfigStr(e.target.value)}
                        />
                        {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
                        <button 
                            onClick={handleSubmit}
                            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition"
                        >
                            啟動 App
                        </button>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 組件: 裁判模式
        // ==========================================
        const RefereeMode = ({ matchData, matchId, appId }) => {
            
            const updateScore = async (team, delta) => {
                const field = team === 'A' ? 'scoreA' : 'scoreB';
                const newScore = Math.max(0, (matchData[field] || 0) + delta);
                
                // 紀錄歷史
                const historyItem = {
                    timestamp: new Date().toISOString(),
                    action: `Score Update`,
                    detail: `${team === 'A' ? matchData.teamA : matchData.teamB} ${delta > 0 ? '+' : ''}${delta}`,
                    scoreSnapshot: `${team === 'A' ? newScore : matchData.scoreA} - ${team === 'B' ? newScore : matchData.scoreB}`
                };

                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('matches').doc(matchId).update({
                        [field]: newScore,
                        history: firebase.firestore.FieldValue.arrayUnion(historyItem),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (err) {
                    console.error("Error updating score:", err);
                    alert("更新失敗: " + err.message);
                }
            };

            const resetMatch = async () => {
                if(!confirm("確定要重置比分與歷史紀錄嗎？")) return;
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('matches').doc(matchId).update({
                        scoreA: 0,
                        scoreB: 0,
                        history: [],
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (err) { console.error(err); }
            };

            const updateNames = async (e) => {
                e.preventDefault();
                const form = e.target;
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('matches').doc(matchId).update({
                        teamA: form.teamA.value,
                        teamB: form.teamB.value
                    });
                    alert("隊伍名稱已更新");
                } catch (err) { console.error(err); }
            };

            return (
                <div className="p-4 max-w-4xl mx-auto">
                    <div className="bg-gray-800 rounded-xl p-6 mb-6 shadow-lg border border-gray-700">
                        <h2 className="text-xl font-bold mb-4 text-yellow-400"><i className="fas fa-whistle mr-2"></i>裁判控制台</h2>
                        
                        {/* Score Controls */}
                        <div className="grid grid-cols-2 gap-8 mb-8">
                            {/* Team A */}
                            <div className="text-center bg-gray-900 p-4 rounded-lg border border-red-900/50">
                                <h3 className="text-red-400 font-bold text-xl mb-2 truncate">{matchData.teamA}</h3>
                                <div className="digital-font text-6xl mb-4 text-white">{matchData.scoreA}</div>
                                <div className="flex justify-center gap-2">
                                    <button onClick={() => updateScore('A', 1)} className="btn-press bg-green-600 hover:bg-green-700 w-12 h-12 rounded-full text-xl font-bold shadow-lg">+</button>
                                    <button onClick={() => updateScore('A', -1)} className="btn-press bg-red-600 hover:bg-red-700 w-12 h-12 rounded-full text-xl font-bold shadow-lg">-</button>
                                </div>
                            </div>

                            {/* Team B */}
                            <div className="text-center bg-gray-900 p-4 rounded-lg border border-blue-900/50">
                                <h3 className="text-blue-400 font-bold text-xl mb-2 truncate">{matchData.teamB}</h3>
                                <div className="digital-font text-6xl mb-4 text-white">{matchData.scoreB}</div>
                                <div className="flex justify-center gap-2">
                                    <button onClick={() => updateScore('B', 1)} className="btn-press bg-green-600 hover:bg-green-700 w-12 h-12 rounded-full text-xl font-bold shadow-lg">+</button>
                                    <button onClick={() => updateScore('B', -1)} className="btn-press bg-red-600 hover:bg-red-700 w-12 h-12 rounded-full text-xl font-bold shadow-lg">-</button>
                                </div>
                            </div>
                        </div>

                        {/* Settings */}
                        <div className="border-t border-gray-700 pt-6">
                            <details className="group">
                                <summary className="cursor-pointer text-gray-400 hover:text-white flex items-center font-medium">
                                    <i className="fas fa-cog mr-2"></i> 比賽設定
                                </summary>
                                <div className="mt-4 p-4 bg-gray-900 rounded">
                                    <form onSubmit={updateNames} className="flex flex-col gap-4 mb-4">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-xs text-gray-500 mb-1">主隊名稱 (紅)</label>
                                                <input name="teamA" defaultValue={matchData.teamA} className="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white" />
                                            </div>
                                            <div>
                                                <label className="block text-xs text-gray-500 mb-1">客隊名稱 (藍)</label>
                                                <input name="teamB" defaultValue={matchData.teamB} className="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white" />
                                            </div>
                                        </div>
                                        <button type="submit" className="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded">更新名稱</button>
                                    </form>
                                    <button onClick={resetMatch} className="w-full border border-red-600 text-red-500 hover:bg-red-600/10 py-2 rounded">
                                        重置比賽
                                    </button>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 組件: 顯示模式 (大螢幕)
        // ==========================================
        const DisplayMode = ({ matchData }) => {
            return (
                <div className="h-full flex flex-col items-center justify-center p-4 bg-black">
                    <div className="w-full max-w-6xl flex justify-between items-center mb-8">
                        <div className="text-center w-1/2 border-r border-gray-800">
                            <h2 className="text-4xl md:text-6xl font-bold text-red-500 mb-4">{matchData.teamA}</h2>
                            <div className="digital-font text-[10rem] md:text-[15rem] leading-none text-white drop-shadow-[0_0_15px_rgba(239,68,68,0.5)]">
                                {matchData.scoreA}
                            </div>
                        </div>
                        <div className="text-center w-1/2">
                            <h2 className="text-4xl md:text-6xl font-bold text-blue-500 mb-4">{matchData.teamB}</h2>
                            <div className="digital-font text-[10rem] md:text-[15rem] leading-none text-white drop-shadow-[0_0_15px_rgba(59,130,246,0.5)]">
                                {matchData.scoreB}
                            </div>
                        </div>
                    </div>
                    <div className="text-gray-500 text-xl font-mono">
                        LIVE MATCH
                    </div>
                </div>
            );
        };

        // ==========================================
        // 組件: 回顧模式
        // ==========================================
        const ReviewMode = ({ matchData }) => {
            const history = matchData.history || [];
            // 反轉 history 讓最新的顯示在上面
            const reversedHistory = [...history].reverse();

            return (
                <div className="p-4 max-w-3xl mx-auto">
                    <div className="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-green-400"><i className="fas fa-history mr-2"></i>比賽紀錄回顧</h2>
                            <div className="text-right">
                                <div className="text-sm text-gray-400">最終比分</div>
                                <div className="font-bold text-xl">{matchData.teamA} {matchData.scoreA} - {matchData.scoreB} {matchData.teamB}</div>
                            </div>
                        </div>

                        {reversedHistory.length === 0 ? (
                            <div className="text-center text-gray-500 py-10">尚無紀錄</div>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="border-b border-gray-700 text-gray-400 text-sm">
                                            <th className="py-2 px-3">時間</th>
                                            <th className="py-2 px-3">事件</th>
                                            <th className="py-2 px-3">詳情</th>
                                            <th className="py-2 px-3 text-right">當時比分</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-sm">
                                        {reversedHistory.map((item, idx) => {
                                            const time = new Date(item.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                                            return (
                                                <tr key={idx} className="border-b border-gray-700/50 hover:bg-gray-700/30 transition">
                                                    <td className="py-3 px-3 font-mono text-gray-500">{time}</td>
                                                    <td className="py-3 px-3 text-white">{item.action}</td>
                                                    <td className="py-3 px-3 text-gray-300">{item.detail}</td>
                                                    <td className="py-3 px-3 text-right font-mono text-yellow-500">{item.scoreSnapshot}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        
                        <div className="mt-6 pt-4 border-t border-gray-700">
                            <h3 className="text-lg font-bold mb-2">統計摘要</h3>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-gray-900 p-3 rounded">
                                    <div className="text-gray-500 text-xs">總得分次數</div>
                                    <div className="text-xl font-bold">{history.length}</div>
                                </div>
                                <div className="bg-gray-900 p-3 rounded">
                                    <div className="text-gray-500 text-xs">領先隊伍</div>
                                    <div className="text-xl font-bold text-yellow-400">
                                        {matchData.scoreA > matchData.scoreB ? matchData.teamA : (matchData.scoreB > matchData.scoreA ? matchData.teamB : '平手')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 主應用程式 Logic
        // ==========================================
        const App = () => {
            // State
            const [isConfigured, setIsConfigured] = useState(isFirebaseReady);
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home'); // 'home', 'match'
            const [currentMatchId, setCurrentMatchId] = useState(null);
            const [mode, setMode] = useState('referee'); // 'referee', 'display', 'review'
            
            // Data
            const [matches, setMatches] = useState([]);
            const [currentMatchData, setCurrentMatchData] = useState(null);
            const [loading, setLoading] = useState(false);

            // App ID for Firestore path encapsulation
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-scoreboard-app';

            // Auth Listener
            useEffect(() => {
                if (isConfigured && auth) {
                    const unsub = auth.onAuthStateChanged(u => {
                        setUser(u);
                    });
                    return () => unsub();
                }
            }, [isConfigured]);

            // Fetch Matches List (Home View)
            useEffect(() => {
                if (!isConfigured || !user || view !== 'home') return;

                setLoading(true);
                // 使用 onSnapshot 確保新增比賽時列表即時更新
                const q = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('matches')
                            .orderBy('createdAt', 'desc')
                            .limit(20);
                
                const unsubscribe = q.onSnapshot(snapshot => {
                    const list = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setMatches(list);
                    setLoading(false);
                }, err => {
                    console.error("Fetch Error", err);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [isConfigured, user, view]);

            // Listen to Specific Match (Match View)
            useEffect(() => {
                if (!isConfigured || !user || view !== 'match' || !currentMatchId) return;

                const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('matches').doc(currentMatchId);
                
                const unsubscribe = docRef.onSnapshot(doc => {
                    if (doc.exists) {
                        setCurrentMatchData(doc.data());
                    } else {
                        alert("比賽不存在");
                        setView('home');
                    }
                }, err => {
                    console.error("Match Sync Error", err);
                });

                return () => unsubscribe();
            }, [isConfigured, user, view, currentMatchId]);

            // Actions
            const createMatch = async () => {
                const nameA = prompt("主隊名稱 (Team A):", "主隊");
                if (!nameA) return;
                const nameB = prompt("客隊名稱 (Team B):", "客隊");
                if (!nameB) return;

                try {
                    const docRef = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('matches').add({
                        teamA: nameA,
                        teamB: nameB,
                        scoreA: 0,
                        scoreB: 0,
                        history: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: user.uid
                    });
                    // 直接跳轉
                    setCurrentMatchId(docRef.id);
                    setMode('referee');
                    setView('match');
                } catch (err) {
                    alert("創建失敗: " + err.message);
                }
            };

            const enterMatch = (id, defaultMode = 'referee') => {
                setCurrentMatchId(id);
                setMode(defaultMode);
                setView('match');
            };

            const goHome = () => {
                setView('home');
                setCurrentMatchId(null);
                setCurrentMatchData(null);
            };

            const copyShareLink = () => {
                // 這裡模擬複製一個參數連結，實際上這需要 URL routing 支持
                // 在單頁應用且無路由庫的情況下，我們只提示
                alert(`請複製此網址並在另一台設備打開 (需手動選擇顯示模式):\n${window.location.href}`);
            };

            // Renders
            if (!isConfigured) {
                return <ConfigScreen onConfigSubmit={() => setIsConfigured(true)} />;
            }

            if (!user) {
                return <div className="h-screen flex items-center justify-center text-gray-400">正在連接伺服器...</div>;
            }

            // --- View: Home ---
            if (view === 'home') {
                return (
                    <div className="min-h-screen bg-gray-900 p-6">
                        <header className="max-w-4xl mx-auto flex justify-between items-center mb-10">
                            <h1 className="text-3xl font-bold text-white tracking-wider">
                                <i className="fas fa-basketball-ball text-orange-500 mr-2"></i>
                                ScoreBoard Pro
                            </h1>
                            <button onClick={createMatch} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-full font-bold shadow-lg transition transform hover:scale-105">
                                <i className="fas fa-plus mr-2"></i>新增比賽
                            </button>
                        </header>

                        <main className="max-w-4xl mx-auto">
                            <h2 className="text-gray-400 text-sm uppercase tracking-widest mb-4">最近的比賽</h2>
                            {loading ? (
                                <div className="text-center py-10">載入中...</div>
                            ) : matches.length === 0 ? (
                                <div className="text-center py-20 bg-gray-800 rounded-xl border border-dashed border-gray-700">
                                    <p className="text-gray-500 text-lg mb-4">目前沒有比賽紀錄</p>
                                    <button onClick={createMatch} className="text-blue-400 hover:text-blue-300 underline">立即建立一場</button>
                                </div>
                            ) : (
                                <div className="grid gap-4">
                                    {matches.map(m => (
                                        <div key={m.id} className="bg-gray-800 p-4 rounded-lg flex items-center justify-between hover:bg-gray-750 transition border border-gray-700">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-4 mb-1">
                                                    <span className="font-bold text-lg text-white">{m.teamA}</span>
                                                    <span className="text-gray-500 font-mono text-xl">{m.scoreA} : {m.scoreB}</span>
                                                    <span className="font-bold text-lg text-white">{m.teamB}</span>
                                                </div>
                                                <div className="text-xs text-gray-500">ID: {m.id.substring(0, 8)}...</div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => enterMatch(m.id, 'display')} className="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm text-blue-300">
                                                    <i className="fas fa-tv mr-1"></i>顯示
                                                </button>
                                                <button onClick={() => enterMatch(m.id, 'review')} className="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm text-green-300">
                                                    <i className="fas fa-chart-bar mr-1"></i>回顧
                                                </button>
                                                <button onClick={() => enterMatch(m.id, 'referee')} className="px-4 py-1 bg-indigo-600 hover:bg-indigo-500 rounded text-sm font-bold">
                                                    進入控制
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </main>
                    </div>
                );
            }

            // --- View: Match (Container) ---
            if (view === 'match' && currentMatchData) {
                // 如果是顯示模式，隱藏頂部導航以求全螢幕效果，但提供一個小的返回按鈕
                if (mode === 'display') {
                    return (
                        <div className="h-screen w-screen relative bg-black overflow-hidden">
                            <button onClick={goHome} className="absolute top-4 left-4 text-gray-700 hover:text-gray-500 z-50 opacity-20 hover:opacity-100 transition">
                                <i className="fas fa-arrow-left fa-2x"></i>
                            </button>
                             <div className="absolute top-4 right-4 z-50 opacity-0 hover:opacity-100 transition">
                                <div className="bg-black/80 text-white text-xs p-2 rounded">
                                    按下 F11 進入全螢幕
                                </div>
                            </div>
                            <DisplayMode matchData={currentMatchData} />
                        </div>
                    );
                }

                // 普通模式 (裁判/回顧) 的佈局
                return (
                    <div className="min-h-screen bg-gray-900 flex flex-col">
                        {/* Navigation Bar */}
                        <nav className="bg-gray-800 border-b border-gray-700 p-4 sticky top-0 z-10 shadow-md">
                            <div className="max-w-4xl mx-auto flex flex-wrap justify-between items-center gap-4">
                                <button onClick={goHome} className="text-gray-400 hover:text-white flex items-center">
                                    <i className="fas fa-chevron-left mr-1"></i> 回列表
                                </button>
                                
                                <div className="flex bg-gray-900 rounded-lg p-1">
                                    <button 
                                        onClick={() => setMode('referee')}
                                        className={`px-4 py-1.5 rounded-md text-sm font-medium transition ${mode === 'referee' ? 'bg-indigo-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                                    >
                                        裁判
                                    </button>
                                    <button 
                                        onClick={() => setMode('display')}
                                        className={`px-4 py-1.5 rounded-md text-sm font-medium transition ${mode === 'display' ? 'bg-indigo-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                                    >
                                        顯示
                                    </button>
                                    <button 
                                        onClick={() => setMode('review')}
                                        className={`px-4 py-1.5 rounded-md text-sm font-medium transition ${mode === 'review' ? 'bg-indigo-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                                    >
                                        回顧
                                    </button>
                                </div>

                                <button onClick={copyShareLink} className="text-gray-400 hover:text-blue-400 text-sm">
                                    <i className="fas fa-share-alt mr-1"></i> 分享
                                </button>
                            </div>
                        </nav>

                        {/* Content Area */}
                        <div className="flex-1 overflow-y-auto">
                            {mode === 'referee' && <RefereeMode matchData={currentMatchData} matchId={currentMatchId} appId={appId} />}
                            {mode === 'review' && <ReviewMode matchData={currentMatchData} />}
                        </div>
                    </div>
                );
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>